# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

# Dispara el pipeline en cada push a master (ajusta si usas otra rama)
trigger:
- master

# Variables (las de FoD las dejamos para después)
variables:
  # Nombre del service connection de FoD (lo usaremos más adelante)
  FOD_CONNECTION: 'FoD_Full_Demo'

# A partir de aquí definimos stages (OJO: 'stages:' va a nivel raíz)
stages:
# =========================================================
# STAGE 1: SCA con Debricked (Core SCA)
# =========================================================
- stage: SCA_Debricked
  displayName: 'Stage SCA – Core SCA (Debricked)'
  jobs:
  - job: CoreSCA
    displayName: 'Análisis SCA con Debricked CLI'
    pool:
      vmImage: 'ubuntu-latest'

    steps:
    - checkout: self

    - task: NodeTool@0
      displayName: 'Instalar Node 18.x'
      inputs:
        versionSpec: '18.x'

    - script: |
        echo "Instalando dependencias del proyecto..."
        npm install
      displayName: 'npm install'

    # Aquí es donde REALMENTE se ejecuta el análisis SCA de Debricked
    - script: |
        echo "Ejecutando análisis SCA con Debricked CLI..."
        docker run --rm \
          -v $(System.DefaultWorkingDirectory):/src \
          -w /src \
          -e DEBRICKED_TOKEN=$(DEBRICKED_TOKEN) \
          debricked/cli:2-resolution-debian \
          debricked scan -t $(DEBRICKED_TOKEN)
      displayName: 'Debricked SCA – debricked scan'
      env:
        # Variable secreta definida en Azure DevOps (Library / Variables del pipeline)
        DEBRICKED_TOKEN: $(DEBRICKED_TOKEN)
